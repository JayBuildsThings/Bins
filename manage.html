<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <meta name="theme-color" content="#ec1313">
    <title>SwiftBins Manager</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;700;800&family=Spline+Sans:wght@300;400;500;600;700&family=Noto+Sans:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>

    <script>
        // --- NAVIGATION & UI ---
        window.navigateTo = function(viewId) {
            const views = document.querySelectorAll('.view');
            views.forEach(el => {
                el.style.display = 'none';
                el.classList.remove('active');
            });
            const target = document.getElementById(viewId);
            if(target) {
                target.style.display = 'block';
                requestAnimationFrame(() => {
                    target.classList.add('active');
                    window.scrollTo(0, 0);
                    if(viewId === 'view-log-activity') {
                        updateTimeField();
                        closeAllDropdowns({target: document.body});
                    } else if(viewId === 'view-bin-locations') {
                        loadBinLocations();
                    } else if(viewId === 'view-contacts') {
                        loadContacts();
                    } else if(viewId === 'view-requests') {
                        loadRequests();
                    }
                });
            }
        };

        window.openMaps = function(address) {
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`, '_blank');
        };

        function updateTimeField() {
            const now = new Date();
            const dateStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const el = document.getElementById('log-display-date');
            if(el) el.innerText = dateStr;
        }

        window.showToast = function(message, isError = false) {
            const toast = document.getElementById('toast-notification');
            const toastMsg = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');
            toastMsg.innerText = message;
            toast.className = `fixed top-6 left-1/2 -translate-x-1/2 bg-surface-dark text-white px-6 py-4 rounded-xl shadow-2xl z-50 flex items-center gap-3 min-w-[300px] border-l-4 ${isError ? 'border-red-500' : 'border-green-500'} transition-all duration-300 transform scale-100 opacity-100`;
            toastIcon.innerText = isError ? "error" : "check_circle";
            setTimeout(() => {
                toast.classList.add('opacity-0', 'scale-90', 'pointer-events-none');
            }, 3000);
        };
    </script>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#ec1313", "primary-yellow": "#f9f506", "background-light": "#f8f6f6", "background-dark": "#221010", "surface-light": "#ffffff", "surface-dark": "#27272a", "status-pickup": "#10b981", "status-issue": "#ef4444", "status-not-assigned": "#9ca3af", "input-light": "#f0f0eb", "input-dark": "#363528" },
                    fontFamily: { "display": ["Lexend", "sans-serif"], "body": ["Noto Sans", "sans-serif"] },
                    borderRadius: {"DEFAULT": "0.5rem", "lg": "1rem", "xl": "1.5rem", "full": "9999px"}
                }
            }
        }
    </script>
    <style>
        body { min-height: 100dvh; background-color: #f8f6f6; overflow-x: hidden; }
        .view { display: none; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .view.active { opacity: 1; }
        #view-main-menu { display: block; opacity: 1; }
        .custom-dropdown::-webkit-scrollbar { width: 4px; }
        .custom-dropdown::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="antialiased text-slate-900 dark:text-white" onclick="closeAllDropdowns(event)">

    <!-- SHARED SECURITY LOCK SCREEN -->
    <div id="lock-screen" class="fixed inset-0 z-[100] bg-dark flex items-center justify-center p-6 hidden">
        <div class="max-w-sm w-full bg-white rounded-3xl p-8 shadow-2xl text-center">
            <div class="w-20 h-20 bg-red-50 text-primary rounded-full flex items-center justify-center mx-auto mb-6">
                <span class="material-symbols-outlined text-4xl">vpn_key</span>
            </div>
            <h2 class="text-2xl font-black mb-2">Private Vault</h2>
            <p class="text-gray-500 text-sm mb-8">Enter your Team's Access Key to view bins and contacts.</p>
            <input type="password" id="access-key-input" placeholder="Enter Access Key" 
                   class="w-full h-14 bg-gray-100 border-none rounded-xl text-center font-bold tracking-widest mb-4 focus:ring-2 focus:ring-primary">
            <button onclick="unlockApp()" class="w-full h-14 bg-primary text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform">
                UNLOCK APP
            </button>
        </div>
    </div>

    <!-- TOAST COMPONENT -->
    <div id="toast-notification" class="fixed top-6 left-1/2 -translate-x-1/2 bg-surface-dark text-white px-6 py-4 rounded-xl shadow-2xl z-50 flex items-center gap-3 min-w-[300px] transition-all duration-300 transform scale-90 opacity-0 pointer-events-none">
        <span id="toast-icon" class="material-symbols-outlined">info</span>
        <span id="toast-message" class="font-bold text-sm"></span>
    </div>

    <!-- ================= VIEW: MAIN MENU ================= -->
    <section id="view-main-menu" class="view active">
        <div class="flex flex-col min-h-screen p-6 max-w-md mx-auto relative pb-20">
            <header class="flex flex-col mt-8 mb-8">
                <h1 class="text-4xl font-extrabold text-slate-900 dark:text-white tracking-tight">SWIFT<span class="text-primary">BINS</span></h1>
                <p class="text-lg text-slate-500 dark:text-slate-400 font-medium mt-1">Management Portal</p>
            </header>

            <div class="flex-1 flex flex-col gap-5">
                <button type="button" onclick="navigateTo('view-log-activity')" class="group relative w-full overflow-hidden rounded-2xl bg-white dark:bg-slate-800 shadow-lg shadow-slate-200/50 dark:shadow-black/20 transition-all active:scale-[0.98] border-2 border-transparent focus:border-primary active:border-primary cursor-pointer">
                    <div class="absolute inset-0 bg-primary opacity-0 group-active:opacity-10 transition-opacity"></div>
                    <div class="flex flex-row items-center h-36 p-4 gap-6">
                        <div class="flex shrink-0 items-center justify-center w-24 h-24 rounded-xl bg-red-100 text-primary dark:bg-red-900/30 dark:text-red-400">
                            <span class="material-symbols-outlined !text-6xl">add_task</span>
                        </div>
                        <div class="flex flex-col items-start justify-center text-left max-w-[160px]">
                            <span class="text-2xl font-extrabold text-slate-900 dark:text-white leading-none mb-1 group-active:text-primary">LOG ACTIVITY</span>
                            <span class="text-sm font-medium text-slate-500 dark:text-slate-400 leading-tight">Report collection or issues</span>
                        </div>
                        <div class="ml-auto pr-2"><span class="material-symbols-outlined text-4xl text-slate-300 group-active:text-primary">arrow_forward_ios</span></div>
                    </div>
                </button>

                <button type="button" onclick="navigateTo('view-bin-locations')" class="group relative w-full overflow-hidden rounded-2xl bg-white dark:bg-slate-800 shadow-lg shadow-slate-200/50 dark:shadow-black/20 transition-all active:scale-[0.98] border-2 border-transparent focus:border-yellow-400 active:border-yellow-400 cursor-pointer">
                    <div class="absolute inset-0 bg-yellow-400 opacity-0 group-active:opacity-10 transition-opacity"></div>
                    <div class="flex flex-row items-center h-36 p-4 gap-6">
                        <div class="flex shrink-0 items-center justify-center w-24 h-24 rounded-xl bg-yellow-100 text-yellow-600 dark:bg-yellow-900/30 dark:text-yellow-400">
                            <span class="material-symbols-outlined !text-6xl">map</span>
                        </div>
                        <div class="flex flex-col items-start justify-center text-left max-w-[160px]">
                            <span class="text-2xl font-extrabold text-slate-900 dark:text-white leading-none mb-1 group-active:text-yellow-600">BIN LOCATIONS</span>
                            <span class="text-sm font-medium text-slate-500 dark:text-slate-400 leading-tight">Map view & status</span>
                        </div>
                        <div class="ml-auto pr-2"><span class="material-symbols-outlined text-4xl text-slate-300 group-active:text-yellow-600">arrow_forward_ios</span></div>
                    </div>
                </button>

                <button type="button" onclick="navigateTo('view-contacts')" class="group relative w-full overflow-hidden rounded-2xl bg-white dark:bg-slate-800 shadow-lg shadow-slate-200/50 dark:shadow-black/20 transition-all active:scale-[0.98] border-2 border-transparent focus:border-orange-500 active:border-orange-500 cursor-pointer">
                    <div class="absolute inset-0 bg-orange-500 opacity-0 group-active:opacity-10 transition-opacity"></div>
                    <div class="flex flex-row items-center h-36 p-4 gap-6">
                        <div class="flex shrink-0 items-center justify-center w-24 h-24 rounded-xl bg-orange-100 text-orange-600 dark:bg-orange-900/30 dark:text-orange-400">
                            <span class="material-symbols-outlined !text-6xl">perm_contact_calendar</span>
                        </div>
                        <div class="flex flex-col items-start justify-center text-left max-w-[160px]">
                            <span class="text-2xl font-extrabold text-slate-900 dark:text-white leading-none mb-1 group-active:text-orange-600">CONTACT LIST</span>
                            <span class="text-sm font-medium text-slate-500 dark:text-slate-400 leading-tight">Names, address & phone numbers</span>
                        </div>
                        <div class="ml-auto pr-2"><span class="material-symbols-outlined text-4xl text-slate-300 group-active:text-orange-600">arrow_forward_ios</span></div>
                    </div>
                </button>

                <!-- REQUESTS BUTTON -->
                <button type="button" onclick="navigateTo('view-requests')" class="group relative w-full overflow-hidden rounded-2xl bg-white dark:bg-slate-800 shadow-lg shadow-slate-200/50 dark:shadow-black/20 transition-all active:scale-[0.98] border-2 border-transparent focus:border-blue-500 active:border-blue-500 cursor-pointer">
                    <div class="absolute inset-0 bg-blue-500 opacity-0 group-active:opacity-10 transition-opacity"></div>
                    <div class="flex flex-row items-center h-36 p-4 gap-6">
                        <div class="flex shrink-0 items-center justify-center w-24 h-24 rounded-xl bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400">
                            <span class="material-symbols-outlined !text-6xl">assignment</span>
                        </div>
                        <div class="flex flex-col items-start justify-center text-left max-w-[160px]">
                            <span class="text-2xl font-extrabold text-slate-900 dark:text-white leading-none mb-1 group-active:text-blue-600">REQUESTS</span>
                            <span class="text-sm font-medium text-slate-500 dark:text-slate-400 leading-tight">Client service requests</span>
                        </div>
                        <div class="ml-auto pr-2"><span class="material-symbols-outlined text-4xl text-slate-300 group-active:text-blue-600">arrow_forward_ios</span></div>
                    </div>
                </button>
            </div>
            
            <div class="mt-8 text-center">
                <button onclick="logout()" class="text-xs font-bold text-slate-300 dark:text-slate-700 hover:text-red-500">VERSION 1.0.36 â€¢ LOGOUT</button>
            </div>
        </div>
    </section>

    <!-- ================= VIEW: LOG ACTIVITY ================= -->
    <section id="view-log-activity" class="view">
        <main class="flex flex-col min-h-screen p-4 max-w-md mx-auto relative bg-background-light dark:bg-background-dark">
            <div class="flex items-center gap-4 mb-6">
                <button onclick="navigateTo('view-main-menu')" class="p-2 -ml-2 rounded-full hover:bg-black/5 active:bg-black/10 transition-colors cursor-pointer"><span class="material-symbols-outlined text-3xl text-gray-800 dark:text-white">arrow_back</span></button>
                <h1 class="font-display font-bold text-2xl text-gray-900 dark:text-white">Log Activity</h1>
            </div>

            <div class="flex-1 flex flex-col gap-5">

                <!-- 1. Activity Type -->
                <div class="flex flex-col gap-2">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Activity Type</label>
                    <div class="relative">
                        <select id="log-type" onchange="autoFillBinDetails()" class="w-full h-14 pl-4 pr-12 rounded-xl bg-input-light dark:bg-input-dark border-none focus:ring-2 focus:ring-primary text-lg font-medium text-gray-900 dark:text-white shadow-sm appearance-none cursor-pointer">
                            <option value="Deliver">Deliver</option>
                            <option value="PickUp">PickUp</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500"><span class="material-symbols-outlined text-2xl">expand_more</span></div>
                    </div>
                </div>
                
                <!-- 2. Bin # -->
                <div class="flex flex-col gap-2 relative z-40">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Bin #</label>
                    <div class="relative">
                        <input type="text" id="log-bin-id" placeholder="Select Bin (e.g. 1)" autocomplete="off" 
                               class="w-full h-14 pl-12 pr-4 rounded-xl bg-input-light dark:bg-input-dark border-none focus:ring-2 focus:ring-primary text-lg font-medium text-gray-900 dark:text-white shadow-sm"
                               oninput="handleBinSearch(this)" onfocus="handleBinSearch(this)" onblur="autoFillBinDetails()">
                        <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-2xl">qr_code_2</span>
                        
                        <!-- Bin Dropdown -->
                        <div id="suggestions-bin" class="custom-dropdown absolute top-full left-0 right-0 mt-2 bg-white dark:bg-surface-dark shadow-xl rounded-xl max-h-60 overflow-y-auto hidden border border-gray-100 dark:border-white/5">
                            <!-- Populated via JS -->
                        </div>
                    </div>
                </div>

                <!-- 3. Client Name -->
                <div class="flex flex-col gap-2 relative z-30">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Client Name</label>
                    <div class="relative">
                        <input type="text" id="log-client-name" placeholder="Name..." autocomplete="off" class="w-full h-14 pl-12 pr-4 rounded-xl bg-input-light dark:bg-input-dark border-none focus:ring-2 focus:ring-primary text-lg font-medium text-gray-900 dark:text-white shadow-sm" oninput="handleAutoFill(this, 'client_name')" onfocus="handleAutoFill(this, 'client_name')">
                        <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-2xl">person</span>
                        <div id="suggestions-client-name" class="custom-dropdown absolute top-full left-0 right-0 mt-2 bg-white dark:bg-surface-dark shadow-xl rounded-xl max-h-60 overflow-y-auto hidden border border-gray-100 dark:border-white/5"></div>
                    </div>
                </div>

                <!-- 4. Address -->
                <div class="flex flex-col gap-2 relative z-20">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Address</label>
                    <div class="relative">
                        <input type="text" id="log-address" placeholder="Enter address..." autocomplete="off" class="w-full h-14 pl-12 pr-4 rounded-xl bg-input-light dark:bg-input-dark border-none focus:ring-2 focus:ring-primary text-lg font-medium text-gray-900 dark:text-white shadow-sm" oninput="handleAutoFill(this, 'address')" onfocus="handleAutoFill(this, 'address')">
                        <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-2xl">location_on</span>
                        <div id="suggestions-address" class="custom-dropdown absolute top-full left-0 right-0 mt-2 bg-white dark:bg-surface-dark shadow-xl rounded-xl max-h-60 overflow-y-auto hidden border border-gray-100 dark:border-white/5"></div>
                    </div>
                </div>

                <!-- 5. Phone Number -->
                <div class="flex flex-col gap-2 relative z-10">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Phone Number</label>
                    <div class="relative">
                        <input type="tel" id="log-phone" placeholder="(555) 000-0000" autocomplete="off" class="w-full h-14 pl-12 pr-4 rounded-xl bg-input-light dark:bg-input-dark border-none focus:ring-2 focus:ring-primary text-lg font-medium text-gray-900 dark:text-white shadow-sm" oninput="handleAutoFill(this, 'phone_number')" onfocus="handleAutoFill(this, 'phone_number')">
                        <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-2xl">phone</span>
                        <div id="suggestions-phone-number" class="custom-dropdown absolute top-full left-0 right-0 mt-2 bg-white dark:bg-surface-dark shadow-xl rounded-xl max-h-60 overflow-y-auto hidden border border-gray-100 dark:border-white/5"></div>
                    </div>
                </div>

                <!-- 6. Date -->
                <div class="flex flex-col gap-2">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Date & Time</label>
                    <div class="flex items-center justify-start gap-3 h-14 w-full px-4 rounded-xl bg-gray-100 dark:bg-white/5 border border-transparent">
                        <span class="material-symbols-outlined text-2xl text-primary">schedule</span>
                        <span id="log-display-date" class="text-base font-bold text-gray-900 dark:text-white">Loading...</span>
                    </div>
                </div>
            </div>
            
            <div class="fixed bottom-0 left-0 right-0 z-20 p-4 bg-gradient-to-t from-background-light via-background-light to-transparent dark:from-background-dark pointer-events-none">
                <div class="max-w-md mx-auto pointer-events-auto">
                    <button id="submit-btn" type="button" onclick="window.submitLog()" class="w-full h-14 bg-primary text-white font-display font-bold text-lg rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 cursor-pointer">
                        <span id="submit-btn-text">SUBMIT LOG</span>
                        <span id="submit-btn-icon" class="material-symbols-outlined">send</span>
                    </button>
                </div>
            </div>
        </main>
    </section>

    <!-- BIN LOCATIONS & CONTACTS -->
    <section id="view-bin-locations" class="view">
        <main class="flex flex-col min-h-screen p-4 max-w-md mx-auto bg-background-light dark:bg-background-dark">
            <div class="flex items-center gap-4 mb-6">
                <button onclick="navigateTo('view-main-menu')" class="p-2 -ml-2 rounded-full hover:bg-black/5 transition-colors cursor-pointer"><span class="material-symbols-outlined text-3xl text-gray-800 dark:text-white">arrow_back</span></button>
                <h1 class="font-display font-bold text-2xl text-gray-900 dark:text-white">Bin Locations</h1>
            </div>
            <div id="bin-list-container" class="flex flex-col gap-4"><p class="text-center text-gray-500 animate-pulse mt-10">Fetching your vault...</p></div>
        </main>
    </section>

    <section id="view-contacts" class="view">
        <main class="flex flex-col min-h-screen p-4 max-w-md mx-auto bg-background-light dark:bg-background-dark">
            <div class="flex items-center gap-4 mb-4">
                <button onclick="navigateTo('view-main-menu')" class="p-2 -ml-2 rounded-full hover:bg-black/5 transition-colors cursor-pointer"><span class="material-symbols-outlined text-3xl text-gray-800 dark:text-white">arrow_back</span></button>
                <h1 class="font-display font-bold text-2xl text-gray-900 dark:text-white">Contact List</h1>
            </div>
            <div class="mb-6 relative"><span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">search</span><input type="text" id="contact-search" placeholder="Search..." class="w-full h-12 pl-12 pr-4 rounded-xl bg-white dark:bg-surface-dark border-none shadow-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-primary" oninput="filterContacts()"></div>
            <div id="contact-list-container" class="flex flex-col pb-20"><p class="text-center text-gray-500 animate-pulse mt-10">Fetching your vault...</p></div>
        </main>
    </section>

    <!-- REQUESTS -->
    <section id="view-requests" class="view">
        <main class="flex flex-col min-h-screen p-4 max-w-md mx-auto bg-background-light dark:bg-background-dark">
            <div class="flex items-center gap-4 mb-6">
                <button onclick="navigateTo('view-main-menu')" class="p-2 -ml-2 rounded-full hover:bg-black/5 transition-colors cursor-pointer"><span class="material-symbols-outlined text-3xl text-gray-800 dark:text-white">arrow_back</span></button>
                <h1 class="font-display font-bold text-2xl text-gray-900 dark:text-white">Requests</h1>
            </div>
            <div id="requests-list-container" class="flex flex-col gap-4 pb-20">
                 <p class="text-center text-gray-500 mt-10 animate-pulse">Loading requests...</p>
            </div>
        </main>
    </section>

    <script>
        const supabaseUrl = 'https://heuhhpjdcphdcrpwmirl.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhldWhocGpkY3BoZGNycHdtaXJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NzIxMTksImV4cCI6MjA4MTU0ODExOX0.FGaDzZFo26DJvMOo5KshwtKLlCXSxVyz-bGBJkD26dI';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        window.masterBins = []; 
        window.requestsData = []; 

        async function initSecurity() {
            const sharedKey = localStorage.getItem('swift_access_key');
            if (!sharedKey) {
                document.getElementById('lock-screen').classList.remove('hidden');
                return;
            }
            await supabase.rpc('set_session_key', { key: sharedKey });
            fetchMasterBins();
        }

        async function fetchMasterBins() {
            const { data } = await supabase.from('master_bins').select('bin_id');
            if(data) {
                window.masterBins = data.map(b => b.bin_id).sort((a,b) => a.localeCompare(b, undefined, {numeric:true}));
            }
        }

        window.unlockApp = function() {
            const key = document.getElementById('access-key-input').value.trim();
            if (key) { localStorage.setItem('swift_access_key', key); location.reload(); }
        };

        window.logout = function() {
            if(confirm("Logout and lock vault?")) { localStorage.removeItem('swift_access_key'); location.reload(); }
        };

        window.handleBinSearch = function(input) {
            const val = input.value.trim().toLowerCase();
            const listEl = document.getElementById('suggestions-bin');
            document.querySelectorAll('.custom-dropdown').forEach(el => { if(el.id !== 'suggestions-bin') el.classList.add('hidden'); });

            const filtered = window.masterBins.filter(b => b.toLowerCase().includes(val));
            if(filtered.length === 0) { listEl.classList.add('hidden'); return; }

            listEl.innerHTML = filtered.map(b => `<div class="p-3.5 hover:bg-gray-100 dark:hover:bg-white/5 cursor-pointer text-lg font-medium border-b border-gray-100 dark:border-white/5" onclick="selectBin('${b}')">Bin #${b}</div>`).join('');
            listEl.classList.remove('hidden');
        };

        window.selectBin = function(binId) {
            document.getElementById('log-bin-id').value = binId;
            document.getElementById('suggestions-bin').classList.add('hidden');
            autoFillBinDetails(); 
        };

        window.autoFillBinDetails = async function() {
            const type = document.getElementById('log-type').value;
            const binId = document.getElementById('log-bin-id').value.trim();
            if (type !== 'PickUp' || !binId) return;

            try {
                const { data } = await supabase.from('activity_logs').select('*').eq('bin_id', binId).order('created_at', { ascending: false }).limit(1).maybeSingle();
                if (data) {
                    if (data.client_name) document.getElementById('log-client-name').value = data.client_name;
                    if (data.address) document.getElementById('log-address').value = data.address;
                    if (data.phone_number) document.getElementById('log-phone').value = data.phone_number;
                    window.showToast("Bin details autofilled");
                }
            } catch (e) { console.error("Autofill error:", e); }
        };

        window.submitLog = async function() {
            const btn = document.getElementById('submit-btn');
            const sharedKey = localStorage.getItem('swift_access_key');
            const binId = document.getElementById('log-bin-id').value.trim();
            const address = document.getElementById('log-address').value.trim();
            
            if(!binId) return window.showToast("Please select a Bin", true);
            if(!address) return window.showToast("Please enter an Address", true);
            if (!window.masterBins.includes(binId)) return window.showToast(`Error: Bin #${binId} does not exist in Master List`, true);

            btn.disabled = true;
            document.getElementById('submit-btn-text').innerText = "Processing...";

            try {
                const { error } = await supabase.from('activity_logs').insert([{
                    bin_id: binId,
                    client_name: document.getElementById('log-client-name').value,
                    address: address,
                    phone_number: document.getElementById('log-phone').value,
                    activity_type: document.getElementById('log-type').value,
                    access_key: sharedKey
                }]);
                if (error) throw error;
                window.showToast("Activity Logged!");
                setTimeout(() => { location.reload(); }, 1000);
            } catch (err) {
                window.showToast(err.message, true);
                btn.disabled = false;
                document.getElementById('submit-btn-text').innerText = "SUBMIT LOG";
            }
        };

        window.loadBinLocations = async function() {
            const container = document.getElementById('bin-list-container');
            const { data, error } = await supabase.from('activity_logs').select('*').order('created_at', { ascending: false });
            if (error) { container.innerHTML = `<p class="text-center text-red-500 mt-10">Access Denied</p>`; return; }
            
            const uniqueBins = new Map();
            data.forEach(log => { if(log.bin_id && !uniqueBins.has(log.bin_id)) uniqueBins.set(log.bin_id, log); });
            
            let binArray = Array.from(uniqueBins.values());
            binArray.sort((a, b) => {
                const aIsDelivered = a.activity_type === 'Deliver';
                const bIsDelivered = b.activity_type === 'Deliver';
                if (aIsDelivered && !bIsDelivered) return -1;
                if (!aIsDelivered && bIsDelivered) return 1;
                return new Date(b.created_at) - new Date(a.created_at);
            });

            container.innerHTML = "";
            binArray.forEach(bin => {
                const isPickup = bin.activity_type === 'PickUp';
                const isDeliver = bin.activity_type === 'Deliver';
                let displayText = isPickup ? 'Not on site' : (isDeliver ? 'Delivered' : 'Unknown');

                const daysDiff = Math.floor((new Date() - new Date(bin.created_at)) / (1000 * 60 * 60 * 24));
                const daysText = daysDiff === 0 ? 'Today' : `${daysDiff} day${daysDiff === 1 ? '' : 's'}`;
                const daysHtml = isDeliver 
                    ? `<div class="text-[10px] text-green-700 font-medium mt-1 text-right">${daysText}</div>` 
                    : `<div class="text-[10px] text-gray-400 font-medium mt-1 text-right">${daysText} ago</div>`;

                container.innerHTML += `
                <article class="bg-surface-light dark:bg-surface-dark p-3.5 rounded-lg shadow-sm border-l-[6px] ${isPickup ? 'border-status-not-assigned' : 'border-status-pickup'}">
                    <div class="flex items-start gap-3">
                        <div class="h-14 w-14 shrink-0 rounded-md bg-primary-yellow text-black flex flex-col items-center justify-center font-bold border border-yellow-500">
                            <span class="text-[10px] uppercase opacity-80">Bin</span><span class="text-xl">${bin.bin_id}</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-1">
                                <h4 class="text-xl font-black">Bin #${bin.bin_id}</h4>
                                <div class="flex flex-col items-end">
                                    <span class="${isPickup ? 'bg-gray-100 text-gray-700' : 'bg-green-100 text-green-700'} text-[10px] font-bold px-1.5 py-0.5 rounded-md uppercase tracking-wide">${displayText}</span>
                                    ${daysHtml}
                                </div>
                            </div>
                            <div class="flex items-center gap-1.5 text-gray-500 text-sm cursor-pointer" onclick="openMaps('${bin.address}')">
                                <span class="material-symbols-outlined text-[18px]">location_on</span>
                                <span class="underline decoration-dotted">${bin.address}</span>
                            </div>
                        </div>
                    </div>
                </article>`;
            });
        };

        window.loadContacts = async function() {
            const container = document.getElementById('contact-list-container');
            const { data, error } = await supabase.from('activity_logs').select('*').order('created_at', { ascending: false });
            if (error) return;
            const uniqueClients = new Map();
            data.forEach(log => { if(log.client_name && !uniqueClients.has(log.client_name)) uniqueClients.set(log.client_name, log); });
            window.allContacts = Array.from(uniqueClients.values()).sort((a,b) => a.client_name.localeCompare(b.client_name));
            renderContacts(window.allContacts);
        };

        function renderContacts(contacts) {
            const container = document.getElementById('contact-list-container');
            container.innerHTML = contacts.map(c => `
                <div class="bg-white dark:bg-surface-dark rounded-xl p-4 shadow-sm mb-4 border border-gray-100 dark:border-white/5">
                    <div class="flex items-start gap-4">
                        <div class="h-12 w-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xl font-bold shrink-0">${c.client_name[0]}</div>
                        <div class="flex-1">
                            <h3 class="text-lg font-bold mb-1">${c.client_name}</h3>
                            <p class="text-sm text-gray-500 mb-1 flex items-center gap-1"><span class="material-symbols-outlined text-sm">location_on</span>${c.address}</p>
                            <p class="text-sm text-gray-500 flex items-center gap-1"><span class="material-symbols-outlined text-sm">phone</span>${c.phone_number}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-4"><a href="tel:${c.phone_number}" class="bg-green-100 text-green-700 h-10 rounded-md font-bold flex items-center justify-center gap-2 text-sm"><span class="material-symbols-outlined text-xl">call</span>Call</a><button onclick="openMaps('${c.address}')" class="bg-primary/10 text-primary h-10 rounded-md font-bold flex items-center justify-center gap-2 text-sm"><span class="material-symbols-outlined text-xl">directions</span>Directions</button></div>
                </div>`).join('');
        }

        // --- CONVERT REQUEST TO ACTIVITY ---
        window.convertRequestToActivity = function(index) {
            const req = window.requestsData[index];
            if (!req) return;

            // 1. Determine Activity Type
            let activityType = 'Deliver'; // Default
            if (req.request_type && req.request_type.toLowerCase().includes('pickup')) {
                activityType = 'PickUp';
            }

            // 2. Populate Log Activity Fields
            document.getElementById('log-type').value = activityType;
            document.getElementById('log-client-name').value = req.client_name || '';
            document.getElementById('log-address').value = req.address || '';
            document.getElementById('log-phone').value = req.phone || '';
            document.getElementById('log-bin-id').value = ''; // Reset bin ID as it needs to be selected manually

            // 3. Navigate
            navigateTo('view-log-activity');
            window.showToast("Details autofilled from request");
        };

        window.loadRequests = async function() {
            const container = document.getElementById('requests-list-container');
            container.innerHTML = `<p class="text-center text-gray-500 mt-10 animate-pulse">Loading requests...</p>`;
            
            try {
                // Fetch All Requests (Unsorted by SQL)
                const { data, error } = await supabase
                    .from('service_requests')
                    .select('*');
                
                if (error) throw error;
                if (!data || data.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 mt-10">No pending requests.</p>`;
                    return;
                }

                // SAVE DATA FOR CLICK HANDLER
                window.requestsData = data.sort((a, b) => {
                    const getEffectiveDate = (req) => {
                        const match = (req.notes || '').match(/(NEEDED ON|PICKUP ON):\s*(\d{4}-\d{2}-\d{2})/);
                        return match ? new Date(match[2]) : new Date(req.created_at);
                    };
                    const dayA = new Date(getEffectiveDate(a)).setHours(0,0,0,0);
                    const dayB = new Date(getEffectiveDate(b)).setHours(0,0,0,0);
                    
                    if (dayA !== dayB) return dayA - dayB;
                    return new Date(a.created_at) - new Date(b.created_at);
                });

                container.innerHTML = window.requestsData.map((req, index) => {
                    const isPickup = req.request_type === 'Pickup';
                    const icon = isPickup ? 'local_shipping' : 'delete';
                    const color = isPickup ? 'text-green-600 bg-green-50' : 'text-blue-600 bg-blue-50';
                    const dateStr = new Date(req.created_at).toLocaleDateString();

                    let displayNotes = req.notes || '';
                    let dateBadgeHtml = '';
                    
                    const dateMatch = displayNotes.match(/(NEEDED ON|PICKUP ON):\s*(\d{4}-\d{2}-\d{2})/);
                    
                    if (dateMatch) {
                        const dateVal = dateMatch[2];
                        displayNotes = displayNotes.replace(dateMatch[0], '').trim();
                        
                        const targetDate = new Date(dateVal);
                        const today = new Date();
                        const diffTime = targetDate - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                        
                        let badgeColor = "bg-gray-100 text-gray-600 border-gray-200"; 
                        if (diffDays <= 1) badgeColor = "bg-orange-100 text-orange-700 border-orange-200";

                        dateBadgeHtml = `
                            <div class="mt-2 flex">
                                <span class="flex items-center gap-1 px-2 py-1 rounded-md text-xs font-bold border ${badgeColor}">
                                    <span class="material-symbols-outlined text-sm">calendar_month</span>
                                    Scheduled: ${dateVal}
                                </span>
                            </div>
                        `;
                    }

                    return `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 shadow-sm border border-gray-100 dark:border-white/5">
                        <div class="flex items-start gap-3">
                            <div class="h-12 w-12 rounded-full ${color} flex items-center justify-center shrink-0">
                                <span class="material-symbols-outlined text-2xl">${icon}</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <h3 class="text-lg font-bold text-gray-900 dark:text-white">${req.request_type}</h3>
                                    <span class="text-xs font-bold text-gray-400">${dateStr}</span>
                                </div>
                                <p class="text-sm font-bold text-gray-700 dark:text-gray-300 mt-1">${req.client_name}</p>
                                <p class="text-sm text-gray-500 flex items-center gap-1 mt-1"><span class="material-symbols-outlined text-sm">location_on</span>${req.address}</p>
                                
                                ${dateBadgeHtml}

                                ${displayNotes ? `<p class="text-sm text-slate-700 dark:text-slate-300 mt-3 bg-slate-50 dark:bg-white/5 p-3 rounded-lg border border-slate-100 dark:border-white/10">"${displayNotes}"</p>` : ''}
                            </div>
                        </div>
                        <div class="mt-4 pt-3 border-t border-gray-100 flex flex-col gap-2">
                             <!-- NEW TURN INTO ACTIVITY BUTTON -->
                             <button onclick="convertRequestToActivity(${index})" class="w-full h-10 bg-primary text-white rounded-lg flex items-center justify-center font-bold text-sm gap-2 shadow-sm hover:bg-red-600 active:scale-95 transition-all">
                                <span class="material-symbols-outlined text-lg">add_task</span> Turn into Activity
                            </button>
                             <button onclick="openMaps('${req.address}')" class="w-full h-10 bg-blue-100 text-blue-700 rounded-lg flex items-center justify-center font-bold text-sm gap-2">
                                <span class="material-symbols-outlined text-lg">map</span> Open Maps
                            </button>
                            <a href="tel:${req.phone}" class="w-full h-10 bg-green-100 text-green-700 rounded-lg flex items-center justify-center font-bold text-sm gap-2">
                                <span class="material-symbols-outlined text-lg">call</span> Call
                            </a>
                        </div>
                    </div>
                    `;
                }).join('');

            } catch(e) {
                console.error(e);
                container.innerHTML = `<p class="text-center text-red-500 mt-10">Error loading requests.</p>`;
            }
        };

        window.handleAutoFill = async function(input, dbColumn) {
            const val = input.value.trim();
            const listId = `suggestions-${dbColumn.replace('_', '-')}`;
            const listEl = document.getElementById(listId);
            
            if(dbColumn === 'client_name' && val === '') {
                document.getElementById('log-address').value = '';
                document.getElementById('log-phone').value = '';
            }

            if(val.length < 1) { listEl.classList.add('hidden'); return; }
            document.querySelectorAll('.custom-dropdown').forEach(d => { if(d.id !== listId) d.classList.add('hidden'); });

            const { data } = await supabase.from('activity_logs').select('*').ilike(dbColumn, `%${val}%`).limit(5);
            if(!data || data.length === 0) return;
            
            listEl.innerHTML = [...new Set(data.map(d => d[dbColumn]))].map(v => 
                `<div class="p-3.5 hover:bg-gray-100 dark:hover:bg-white/5 cursor-pointer text-sm border-b border-gray-100 dark:border-white/5" onclick="selectSug('${v}', '${dbColumn}')">${v}</div>`
            ).join('');
            listEl.classList.remove('hidden');
        };

        window.selectSug = async function(val, col) {
            document.getElementById(`log-${col.replace('_', '-')}`).value = val;
            document.querySelectorAll('.custom-dropdown').forEach(d => d.classList.add('hidden'));
            
            const { data } = await supabase.from('activity_logs').select('*').eq(col, val).order('created_at', { ascending: false }).limit(1);

            if(data[0]) {
                if(data[0].bin_id) document.getElementById('log-bin-id').value = data[0].bin_id;
                if(data[0].client_name) document.getElementById('log-client-name').value = data[0].client_name;
                if(data[0].address) document.getElementById('log-address').value = data[0].address;
                if(data[0].phone_number) document.getElementById('log-phone').value = data[0].phone_number;
            }
        };

        window.closeAllDropdowns = (e) => { 
            if(e.target.tagName !== 'INPUT' && !e.target.classList.contains('custom-dropdown')) {
                document.querySelectorAll('.custom-dropdown').forEach(d => d.classList.add('hidden')); 
            }
        };

        initSecurity();
    </script>
</body>
</html>
